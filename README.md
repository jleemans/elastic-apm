# Intro

## Credit

This document is based on the medium.com article [Monitor Spring Boot Application Performance with Elastic APM, Elasticsearch and Kibana](https://medium.com/@sece.cosmin/monitor-spring-boot-application-performance-with-elastic-apm-elasticsearch-and-kibana-8d4299cad2be) by Cosmin Seceleanu.

Cosmin has set up a sample container-based setup where he has a Spring Boot app with some REST endpoints for user
management and which uses a relational database under the hood. It is being monitored using Elastic APM. The full
stack of container contains:
- the Spring Boot microservice
- a MySQL database
- Elastic APM Server
- ElasticSearch
- Kibana

## Modifications

Cosmin's repo was forked into [https://github.com/jleemans/elastic-apm](https://github.com/jleemans/elastic-apm), with
the following modifications:
- removed tutorials not related to elastic-apm
- version upgrades:
  - upgraded Lombok to 1.8.26 (to be JDK 17 compliant)

# Building

Just run a `mvn package`, it should not give any issues.

# Running

## Run `docker compose` (or `podman compose`, ...)

```
docker compose up -d
```

You may have to explicitly restart the APM server (sometimes also the microservice), since they shut down if the
containers that they depend on don't start up quick enough. Give it a bit of time before doing a:

```
docker compose restart apm
```

A more robust docker setup can avoid this, but it's not a priority at the moment. For now, keep going until all
containers are started successfully.

# Sample requests

In this folder you'll find a `loadtest.lua` script that can be used to run a load test using `wrk`. You need to make
sure that you have `wrk` installed:
```
brew install wrk
```

Then you can launch the test as follows (feel free to play around with the params):
```
# 2 threads, 5 connections, 10 seconds duration
wrk -t2 -c5 -d10s -s loadtest.lua http://localhost:8080
```

The script will:
- randomly (50/50) create a new user with random data (generated by the script), or fetch an already created user
- when creating a user, in 20% of the cases it will override the name and email by those fetched using an external
  API (randomuser.me). Unless that randomuser.me API returns funky data (names with dashes, non-ascii names, ...) then
  it will keep the original values.

That should be enough to see data pop up in Elastic. Check the results in the [Kibana APM tab](http://localhost:5601/).

# Features

Check out [this feature overview](docs/features.md) to get an idea of what you can expect from Elastic APM. The best
way is still to play around with this stack yourself.
